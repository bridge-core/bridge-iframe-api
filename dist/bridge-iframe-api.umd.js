(function(r,o){typeof exports=="object"&&typeof module!="undefined"?o(exports):typeof define=="function"&&define.amd?define(["exports"],o):(r=typeof globalThis!="undefined"?globalThis:r||self,o(r.BridgeIframeAPI={}))})(this,function(r){"use strict";class o{constructor(e=window.top){if(!e)throw new Error("You must provide a valid target in order to create a channel");this.target=e}matchesChannel(e){return e===void 0?!0:this.channelId?this.channelId===e:!1}open(e=3e3){if(!this.channelId)return new Promise((t,n)=>{const a=setTimeout(()=>{n(new Error("Channel target did not respond"))},e),l=this.on("connect",(d,s,i)=>{if(this.channelId)throw new Error("Invalid state: Channel is already open but still listens for connect events");clearTimeout(a),l.dispose(),this.channelId=crypto.randomUUID(),i(this.channelId),t()})})}async connect(){if(this.channelId)return;const e=await this.trigger("connect",null);this.channelId=e}trigger(e,t,n){const a=this.simpleTrigger(e,t);return new Promise((l,d)=>{const s=h=>{const{type:u,uuid:g,channelId:p,error:c,payload:f}=h.data;if(!(u!=="response"||!this.matchesChannel(p)||g!==a)){if(c){d(c);return}i&&clearTimeout(i),globalThis.removeEventListener("message",s),l(f)}},i=n?setTimeout(()=>{globalThis.removeEventListener("message",s)},n):null;globalThis.addEventListener("message",s)})}simpleTrigger(e,t){const n=crypto.randomUUID();return this.target.postMessage({type:e,channelId:this.channelId,uuid:n,origin:window.origin,payload:t},"*"),n}on(e,t){if(e==="response")throw new Error("The response event type is reserved for internal use.");const n=a=>{const{type:l,channelId:d,origin:s,uuid:i,payload:h}=a.data;l!==e||!this.matchesChannel(d)||t(h,s,this.createResponseFunction(i))};return globalThis.addEventListener("message",n),{dispose:()=>{globalThis.removeEventListener("message",n)}}}createResponseFunction(e){return t=>{this.target.postMessage({type:"response",channelId:this.channelId,uuid:e,origin:window.origin,payload:t},"*")}}}r.Channel=o,Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
